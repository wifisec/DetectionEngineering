//Title: WSUS Remote Code Execution Vulnerability Exploitation (CVE-2025-59287)
//Description: This rule detects suspicious process activity originating from Windows Server Update Services (WSUS) processes (wsusservice.exe or w3wp.exe with 'wsuspool' in its command line) that then execute known Living Off The Land Binaries (LOLBINs) associated with ingress tool transfer (T1105) or common Windows execution binaries such as cmd.exe, powershell.exe, or certutil.exe. This behavior could indicate the exploitation of a Remote Code Execution vulnerability in WSUS, such as CVE-2025-59287.
//Author(s): Adair John Collins
//Date: 10/25/2025
//Version: 1
//Load the LOLBAS dataset from the official project site.
//This dataset contains known living-off-the-land binaries and scripts (LOLBAS) that attackers may abuse.
let lolbas = externaldata(
    Filename:string,                    // Name of the binary or script
    Description:string,                 // Description of its typical use
    Author:string,                      // Contributor to the LOLBAS project
    Date:datetime,                      // Date of entry or update
    Command:string,                     // Example command line usage
    CommandDescription:string,          // Description of the command
    CommandUsecase:string,              // Use case for the command
    CommandCategory:string,             // Category (e.g., execution, defense evasion)
    CommandPrivileges:string,           // Required privileges to execute
    Technique:string,                   // MITRE ATT&CK technique ID
    OperatingSystem:string,             // Applicable operating system
    Paths:string,                       // Typical file paths
    Detections:string,                  // Detection guidance
    Resources:string,                   // Additional resources
    Acknowledgements:string,            // Credits and contributors
    URL:string                          // Reference URL
)[@"https://lolbas-project.github.io/api/lolbas.csv"] with (format="csv", ignoreFirstRecord=True);
//Extract filenames associated with MITRE ATT&CK technique T1105 (Ingress Tool Transfer).
//T1105 refers to transferring tools or files from external sources into the target environment.
let IngressToolTransfer = (lolbas | where Technique == "T1105" | distinct Filename);
//Uncomment the line below to preview the list of filenames used for ingress tool transfer.
//IngressToolTransfer
//The following query (commented out) is designed to detect suspicious process activity related to WSUS exploitation.
//It filters for processes initiated by WSUS-related services and checks if they invoke known LOLBINs or common execution tools.
DeviceProcessEvents
| where  
    InitiatingProcessFileName has "wsusservice.exe" // WSUS service process
    or (
        InitiatingProcessFileName has "w3wp.exe"     // IIS worker process
        and InitiatingProcessCommandLine has "wsuspool" // Specific to WSUS application pool
    )
    and (
        FileName has_any (IngressToolTransfer)       // Matches known LOLBINs ingress tool transfer binaries
        or FileName has_any (                        // Matches common Windows execution binaries
            "cmd.exe", "powershell.exe", "powershell_ise.exe", "pwsh.exe", @"wt ", "wt.exe", "WindowsTerminal.exe",
            "mshta.exe", "wscript.exe", "cscipt.exe", "curl.exe", "certutil.exe", "rundll32.exe", "regsvr32.exe",
            "bitsadmin.exe", "msiexec.exe"
        )
    )
//Reference(s):
//https://www.huntress.com/blog/exploitation-of-windows-server-update-services-remote-code-execution-vulnerability
